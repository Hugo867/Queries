-- OPS_GLOBAL.RT_ACQUISITION
WITH LEADS_LW AS (

  
SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::DATE AS WEEK,
COUNT(DISTINCT RL.STOREKEEPER_REQUEST_ID) AS LEADS

FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3

),

REGISTERED AS (

  
SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::DATE AS WEEK,
COUNT(DISTINCT RL.STOREKEEPER_REQUEST_ID) AS REGISTERED_RTS

FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.COUNTRY = 'BR'
AND RL.REGISTERED_AT IS NOT NULL
AND RL.REGISTERED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.REGISTERED_AT::DATE) <=3
  
GROUP BY 1,2,3

),

APPROVED AS (
  
SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::dATE AS WEEK,
COUNT(DISTINCT RL.RT_ID) AS APPROVED_RTS


FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.APPROVED_AT IS NOT NULL
AND RL.CURRENT_STATE = 'APPROVED'
AND APPROVED_AT IS NOT NULL
AND APPROVED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.APPROVED_AT::DATE) <=3
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3 
 
  
),

FIRST_CONNECTION AS(
    

SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::dATE AS WEEK,
COUNT(DISTINCT RL.RT_ID) AS FIRST_CONNECTION_RTS


FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.APPROVED_AT IS NOT NULL
AND RL.CURRENT_STATE = 'APPROVED'
AND APPROVED_AT IS NOT NULL
AND APPROVED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_CONNECTION_AT IS NOT NULL
AND RL.FIRST_CONNECTION_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.FIRST_CONNECTION_AT::DATE) <=3
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3 
),

FIRST_ITERATION AS(
    
SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::dATE AS WEEK,
COUNT(DISTINCT RL.RT_ID) AS FIRST_ITERATION_RTS


FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.APPROVED_AT IS NOT NULL
AND RL.CURRENT_STATE = 'APPROVED'
AND APPROVED_AT IS NOT NULL
AND APPROVED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_CONNECTION_AT IS NOT NULL
AND RL.FIRST_CONNECTION_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_ITERATION_AT IS NOT NULL
AND RL.FIRST_ITERATION_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.FIRST_ITERATION_AT::DATE) <=3
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3 

),

FIRST_PROSPECT AS (

SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::dATE AS WEEK,
COUNT(DISTINCT RL.RT_ID) AS FIRST_PROSPECT_RTS


FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.APPROVED_AT IS NOT NULL
AND RL.CURRENT_STATE = 'APPROVED'
AND APPROVED_AT IS NOT NULL
AND APPROVED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_ITERATION_AT IS NOT NULL
AND RL.FIRST_ITERATION_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_PROSPECT_AT IS NOT NULL
AND RL.FIRST_PROSPECT_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.FIRST_PROSPECT_AT::DATE) <=3
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3 
),

FIRST_NOTIFIED AS(

SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::dATE AS WEEK,
COUNT(DISTINCT RL.RT_ID) AS FIRST_NOTIFICATION_RTS


FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.APPROVED_AT IS NOT NULL
AND RL.CURRENT_STATE = 'APPROVED'
AND APPROVED_AT IS NOT NULL
AND APPROVED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_PROSPECT_AT IS NOT NULL
AND RL.FIRST_PROSPECT_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_NOTIFICATION_AT IS NOT NULL
AND RL.FIRST_NOTIFICATION_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.FIRST_NOTIFICATION_AT::DATE) <=3
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3 

),

FIRST_TAKEN AS(

SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::dATE AS WEEK,
COUNT(DISTINCT RL.RT_ID) AS FIRST_TAKEN_RTS


FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.APPROVED_AT IS NOT NULL
AND RL.CURRENT_STATE = 'APPROVED'
AND APPROVED_AT IS NOT NULL
AND APPROVED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_NOTIFICATION_AT IS NOT NULL
AND RL.FIRST_NOTIFICATION_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.FIRST_TAKE_AT IS NOT NULL
AND RL.FIRST_TAKE_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.FIRST_TAKE_AT::DATE) <=3
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3 

    
),

FIRST_ORDER AS(

SELECT RL.COUNTRY,
RL.CITY,
--RL.TRANSPORT_MEDIA_TYPE,
DATE_TRUNC('week',RL.CREATED_AT_REQUEST)::dATE AS WEEK,
COUNT(DISTINCT RL.RT_ID) AS FIRST_ORDER_RTS


FROM OPS_GLOBAL.RT_ACQUISITION RL
  
WHERE RL.CREATED_AT_REQUEST::DATE BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.APPROVED_AT IS NOT NULL
AND RL.CURRENT_STATE = 'APPROVED'
AND APPROVED_AT BETWEEN '2021-11-01' AND CURRENT_DATE
AND RL.ORDER_1_AT IS NOT NULL
AND RL.ORDER_1_AT  BETWEEN '2021-11-01' AND CURRENT_DATE
AND DATEDIFF(day,RL.CREATED_AT_REQUEST::DATE,RL.ORDER_1_AT::DATE) <=3
AND RL.COUNTRY = 'BR'
  
GROUP BY 1,2,3 
)

SELECT
L.CITY,
L.WEEK,
L.LEADS,
R.REGISTERED_RTS,
A.APPROVED_RTS,
C.FIRST_CONNECTION_RTS,
I.FIRST_ITERATION_RTS,
P.FIRST_PROSPECT_RTS,
N.FIRST_NOTIFICATION_RTS,
T.FIRST_TAKEN_RTS,
F.FIRST_ORDER_RTS


FROM LEADS_LW L
LEFT JOIN APPROVED A ON L.COUNTRY = A.COUNTRY AND L.CITY = A.CITY AND L.WEEK = A.WEEK
--LEFT JOIN FIRST_ORDER F ON L.COUNTRY = F.COUNTRY AND L.CITY = F.CITY AND L.WEEK = F.WEEK 
LEFT JOIN FIRST_CONNECTION C ON L.COUNTRY = C.COUNTRY AND L.CITY = C.CITY AND L.WEEK = C.WEEK 
LEFT JOIN FIRST_ITERATION I ON L.COUNTRY = I.COUNTRY AND L.CITY = I.CITY AND L.WEEK = I.WEEK 
LEFT JOIN FIRST_PROSPECT P ON L.COUNTRY = P.COUNTRY AND L.CITY = P.CITY AND L.WEEK = P.WEEK 
LEFT JOIN FIRST_NOTIFIED N ON L.COUNTRY = N.COUNTRY AND L.CITY = N.CITY AND L.WEEK = N.WEEK --FIRST_TAKEN
LEFT JOIN FIRST_TAKEN T ON L.COUNTRY = T.COUNTRY AND L.CITY = T.CITY AND L.WEEK = T.WEEK --FIRST_TAKEN
LEFT JOIN FIRST_ORDER F ON L.COUNTRY = F.COUNTRY AND L.CITY = F.CITY AND L.WEEK = F.WEEK --FIRST_TAKEN
LEFT JOIN REGISTERED R ON L.COUNTRY = R.COUNTRY AND L.CITY = R.CITY AND L.WEEK = R.WEEK

--WHERE L.WEEK = '2022-10-10'
