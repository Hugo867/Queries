[18:02, 30/01/2023] Victor Ghisi: with a as(

SELECT 
'BR' AS COUNTRY,
DATE_TRUNC('week',DD.CREATED_AT::DATE) AS DIA,
CASE WHEN ME.DESCRIPTION ILIKE '%who refers%' THEN 'Referidor'
     WHEN ME.DESCRIPTION ILIKE '%referred%' THEN 'Referido' else 'ajuste_manual' END AS TIPO,
SUM(DD.TOTAL)/5.2 AS PAGO_USD
FROM BR_PGLR_MS_DISPERSION_CALCULATOR_PUBLIC.DISPERSION_DETAILS_VW DD
LEFT JOIN BR_PGLR_MS_DISPERSION_CALCULATOR_PUBLIC.MANUAL_EARNINGS ME ON DD.MODEL_ID = ME.ID AND DD.REASON_TYPE_ID = 51 AND NOT ME._FIVETRAN_DELETED
LEFT JOIN BR_PGLR_MS_DISPERSION_CALCULATOR_PUBLIC.MANUAL_EARNING_REASONS MER ON MER.ID = ME.MANUAL_EARNING_REASON_ID AND NOT MER._FIVETRAN_DELETED
LEFT JOIN BR_PGLR_MS_DISPERSION_CALCULATOR_PUBLIC.PAID_LOTS_VW P ON DD.PAID_LOT_ID = P.ID AND NOT P._FIVETRAN_DELETED
LEFT JOIN BR_PG_MS_STOREKEEPERS_PUBLIC.STOREKEEPERS_OFUSCATED SO ON SO.ID = DD.STOREKEEPER_ID
LEFT JOIN GLOBAL_FINANCES.GLOBAL_ORDERS AS OD ON DD.MODEL_ID = OD.ORDER_ID AND OD.COUNTRY = 'BR'
LEFT JOIN GLOBAL_FINANCES.TBL_DIM_GEOGRAPHY_T1 AS G ON OD.MICROZONE_ID = G.MICROZONE_CODE AND OD.COUNTRY = G.SOURCE_TABLE
WHERE MER.NAME ilike '%refer%'
and DD.REASON_TYPE_ID = 51
AND DD.STATE_ID IN (2)
AND COALESCE(P.STATUS, 'OTRO') NOT IN ('error')
AND DD.CREATED_AT::DATE >= '2022-01-01' 
GROUP BY 1,2,3


)
select 
country,
dia week,
pago_usd
from a
where dia >= DATE_TRUNC('week',current_date) - interval '10 weeks'
order by 1,2
[18:02, 30/01/2023] Victor Ghisi: Paid Media cost:

SELECT DISTINCT 
GOC.COUNTRY,
DATE_TRUNC('WEEK', DAY::DATE) AS WEEK, 
ROUND(SUM(CASE WHEN account_name = 'RT - BRASIL - ACQ - Uber Eats Plan' THEN 0 ELSE COST END),2) AS SPEND
FROM GLOBAL_FINANCES.GLOBAL_ONLINE_COST GOC
WHERE OBJECTIVE_COST = 'RTS'
AND DAY::DATE >= DATE_TRUNC('week',current_date) - interval '10 weeks'
and GOC.COUNTRY = 'BR'
GROUP BY 1,2
ORDER BY 1,2
